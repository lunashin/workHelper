<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>業務ログ統合ビューア（名称｜日時｜データ種類｜カテゴリ名｜詳細）</title>
<style>
  :root{
    --bg:#0b1020; --panel:#141a2b; --ink:#e6e9f5; --muted:#9aa3b2; --acc:#4ea1ff; --bd:#24304b;
  }
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,'Noto Sans JP',sans-serif;line-height:1.5;}
  header{padding:16px 20px;border-bottom:1px solid var(--bd);position:sticky;top:0;background:linear-gradient(180deg,var(--bg),#0b1020e6 70%,#0b102000);}
  h1{margin:0;font-size:18px;font-weight:700;letter-spacing:.02em}

  /* ===== 2カラムレイアウト（左右独立スクロール） ===== */
  .wrap{max-width:1400px;margin:0 auto;padding:16px;}
  .two-col{
    display:grid;
    grid-template-columns:minmax(360px,520px) 1fr;
    gap:16px;
    align-items:start;
    height:calc(100vh - 72px);
  }
  .left, .right{display:flex;flex-direction:column;gap:12px;min-height:0;overflow:auto;}
  .left{padding-right:2px;}
  .right{padding-left:2px;}

  /* ===== カード/フォーム/テーブル ===== */
  .card{background:var(--panel);border:1px solid var(--bd);border-radius:14px;padding:12px 12px 10px}
  .card h2{margin:2px 0 10px;font-size:14px;color:var(--muted);font-weight:600}
  .controls{display:flex;flex-wrap:wrap;gap:12px;align-items:center}
  .controls.sticky{position:sticky;top:10px;z-index:2;}
  label{font-size:13px;color:var(--muted)}
  input[type="date"]{background:#0e1424;color:var(--ink);border:1px solid var(--bd);border-radius:8px;padding:6px 10px}
  button{background:var(--acc);color:#041224;border:none;border-radius:10px;padding:10px 16px;font-weight:700;cursor:pointer}
  button.secondary{background:transparent;border:1px solid var(--bd);color:var(--ink)}
  button.ghost{background:transparent;border:1px dashed var(--bd);color:var(--muted)}
  textarea{width:100%;min-height:110px;resize:vertical;background:#0e1424;color:var(--ink);border:1px solid var(--bd);border-radius:10px;padding:10px;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  .hint{font-size:12px;color:var(--muted)}

  .out-card{display:flex;flex-direction:column;min-height:0}
  .table-scroll{overflow:auto;min-height:0;flex:1;border-radius:12px}
  table{width:100%;border-collapse:collapse;background:var(--panel);border:1px solid var(--bd);border-radius:12px;overflow:hidden}
  thead th{font-size:12px;text-align:left;color:var(--muted);padding:10px;border-bottom:1px solid var(--bd);background:#0f1629;position:sticky;top:0}
  tbody td{padding:10px;border-bottom:1px solid var(--bd);font-size:13px;vertical-align:top}
  .muted{color:var(--muted)}

  @media(max-width:900px){
    .two-col{grid-template-columns:1fr; height:auto;}
    .left,.right{overflow:visible}
  }
</style>
</head>
<body>
  <header>
    <h1>業務ログ統合ビューア（名称｜日時｜データ種類｜カテゴリ名｜詳細）</h1>
  </header>

  <div class="wrap">
    <div class="two-col">
      <!-- 左：入力エリア -->
      <div class="left">
        <div class="card controls sticky">
          <div class="controls">
            <label>対象日：
              <input id="targetDate" type="date">
            </label>
            <button id="run">集計する</button>
            <button id="downloadCsv" class="secondary">CSVダウンロード</button>
            <span class="hint">※ 時刻のみ（例: 10:00）は対象日で補完。出力は日時でソート。</span>
          </div>
        </div>

        <div class="card">
          <h2>ファイルを開いた履歴（ファイル名<TAB>時刻）</h2>
          <textarea id="taOpen" placeholder="example.txt\t10:00"></textarea>
        </div>

        <div class="card">
          <h2>ファイル作成・更新履歴（ファイル名<TAB>MM/dd/yyyy h:mm AM/PM [GMT-7]）</h2>
          <textarea id="taCreateUpdate" placeholder="report.docx\t2/14/2024 6:00 AM
report.docx\t6/15/2024 7:48 PM"></textarea>
          <div class="hint">※ 「GMT-7」表記が無くても既定で GMT-7 として解釈し、ローカル時刻に換算して表示します。</div>
        </div>

        <div class="card">
          <h2>メール送信履歴（件名<TAB>HH:mm）</h2>
          <textarea id="taMail" placeholder="見積提示の件\t10:00"></textarea>
        </div>

        <div class="card">
          <h2>Teams通話履歴（相手<TAB>開始<TAB>終了）</h2>
          <textarea id="taTeams" placeholder="山田さん\t10:00\t11:00"></textarea>
        </div>

        <div class="card">
          <h2>Teamsチャット履歴（チャネル/スレッド名<TAB>時刻）</h2>
          <textarea id="taTeamsChat" placeholder="#案件A/仕様相談スレッド\t10:00"></textarea>
        </div>

        <div class="card">
          <h2>会議履歴（会議名(開始 〜 終了 / 所要)）</h2>
          <textarea id="taMeet" placeholder="定例A(10:00 〜 11:00 / 1h)"></textarea>
        </div>

        <!-- ★★ 追加：ブラウザアクセス履歴 ★★ -->
        <div class="card">
          <h2>ブラウザアクセス履歴（DateTime<TAB>NavigatedToUrl<TAB>PageTitle）</h2>
          <textarea id="taBrowser" placeholder="2025-09-29T23:25:21.936Z	https://mmna-my.sharepoint.com/	ホーム - OneDrive"></textarea>
          <div class="hint">※ DateTimeはUTC。出力はJST(+9)に変換。URLは無視し、PageTitleを「名称」に使用します。</div>
        </div>

        <div class="card">
          <h2>勤怠情報（勤怠情報<TAB>時刻）</h2>
          <textarea id="taKintai" placeholder="業務開始\t8:30"></textarea>
        </div>

        <div class="card">
          <h2>カテゴリ名と条件（カテゴリ名<TAB>条件1<TAB>条件2(任意)）</h2>
          <textarea id="taCategory" placeholder="法規(運用)\t法規\tCVE"></textarea>
          <div class="controls" style="margin-top:8px;gap:8px">
            <button id="btnLoadCategory" class="ghost">保存済みを読込</button>
            <span class="hint">※ 集計実行時に自動保存。ページ読込時も自動復元します。</span>
          </div>
        </div>

        <div class="card">
          <h2>詳細と条件（詳細内容<TAB>名称欄の一致条件）</h2>
          <textarea id="taDetailRules" placeholder="見積作成\t見積"></textarea>
          <div class="hint">※ 「名称」に部分一致した最初のルールを「詳細」として採用します。</div>
        </div>
      </div>

      <!-- 右：出力テーブル -->
      <div class="right">
        <div class="card out-card">
          <h2>出力（名称｜日時｜データ種類｜カテゴリ名｜詳細）</h2>
          <div class="table-scroll">
            <table id="outTable" aria-live="polite">
              <thead>
                <tr><th>名称</th><th>日時</th><th>データ種類</th><th>カテゴリ名</th><th>詳細</th></tr>
              </thead>
              <tbody id="outBody">
                <tr><td class="muted" colspan="5">まだ出力がありません。</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

    </div>
  </div>

<script>
(function(){
  // ===== LocalStorage Keys =====
  const LS_KEY_CATEGORY     = 'taskAnalyzer.categoryRules.v1';
  const LS_KEY_DETAILRULES  = 'taskAnalyzer.detailRules.v1';
  const LS_KEY_KINTAI       = 'taskAnalyzer.kintai.v1';

  // ===== 共通ユーティリティ =====
  function fmtYmdHM(date){
    if(!(date instanceof Date) || isNaN(date)) return '';
    const y = date.getFullYear();
    const m = String(date.getMonth()+1).padStart(2,'0');
    const d = String(date.getDate()).padStart(2,'0');
    const hh = String(date.getHours()).padStart(2,'0');
    const mm = String(date.getMinutes()).padStart(2,'0');
    return `${y}/${m}/${d} ${hh}:${mm}`;
  }
  function lines(str){
    return (str||'').replace(/\r\n?/g,'\n').split('\n').map(s=>s.trim()).filter(Boolean);
  }

  // 前営業日（週末除く）を YYYY-MM-DD 文字列で返す
  function prevBusinessDayYMD(){
    const t = new Date();
    t.setHours(0,0,0,0);
    const d = new Date(t.getFullYear(), t.getMonth(), t.getDate() - 1);
    while([0,6].includes(d.getDay())){ d.setDate(d.getDate() - 1); }
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const da = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${da}`;
  }

  function getTargetDate(){
    const el = document.getElementById('targetDate');
    const v = el.value;
    if(!v){
      el.value = prevBusinessDayYMD(); // 既定＝前営業日
      return getTargetDate();
    }
    const [yy,mm,dd] = v.split('-').map(n=>parseInt(n,10));
    return new Date(yy, mm-1, dd, 0, 0, 0, 0);
  }

  // ===== 解析系 =====
  // MM/dd/yyyy h:mm AM/PM （GMT記載なし→既定で GMT-7）をローカル時刻へ
  function parseUsAmPmAssumeGMTMinus7(s){
    let offset = -7;
    const tzMatch = s.match(/\bGMT\s*([+-]\d{1,2})\b/i);
    if(tzMatch){
      offset = parseInt(tzMatch[1],10);
      s = s.replace(/\bGMT\s*[+-]?\d{1,2}\b/i,'').trim();
    }
    const m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})\s+(\d{1,2}):(\d{2})\s*([AP]M)$/i);
    if(!m) return null;
    let [_, M, D, Y, h, min, ap] = m;
    M = +M; D = +D; Y = +Y; h = +h; min = +min; ap = ap.toUpperCase();
    if(ap === 'PM' && h !== 12) h += 12;
    if(ap === 'AM' && h === 12) h = 0;
    const MM = String(M).padStart(2,'0');
    const DD = String(D).padStart(2,'0');
    const HH = String(h).padStart(2,'0');
    const mm2 = String(min).padStart(2,'0');
    const sign = offset >= 0 ? '+' : '-';
    const abs = Math.abs(offset);
    const tz = `${sign}${String(abs).padStart(2,'0')}:00`;
    const iso = `${Y}-${MM}-${DD}T${HH}:${mm2}:00${tz}`;
    return new Date(iso);
  }
  function parseTimeOnTargetDay(s, targetDate){
    const m = s.match(/^(\d{1,2}):(\d{2})$/);
    if(!m) return null;
    const [_,hh,mm] = m.map(Number);
    return new Date(targetDate.getFullYear(), targetDate.getMonth(), targetDate.getDate(), hh, mm, 0, 0);
  }

  // JST(+9)での表示用（UTCのDate -> JSTの"壁時計"に直して既存フォーマットで表示）
  function fmtYmdHM_JST(utcDate){
    if(!(utcDate instanceof Date) || isNaN(utcDate)) return '';
    // 現地タイムゾーンとの差分を考慮して JST の壁時計に合わせる（日本はDSTなし）
    const deltaMinutes = (9*60) + utcDate.getTimezoneOffset(); // +540 - localOffset
    const jstDate = new Date(utcDate.getTime() + deltaMinutes*60000);
    return fmtYmdHM(jstDate);
  }

  // ===== カテゴリ判定 =====
  function parseCategoryRules(text){
    const arr = lines(text);
    const rules = [];
    for(const line of arr){
      const parts = line.split('\t');
      const cat = (parts[0]||'').trim();
      const c1  = (parts[1]||'').trim();
      const c2  = (parts[2]||'').trim();
      if(!cat || !c1) continue; // 条件1は必須
      rules.push({ cat, c1, c2: c2 || null });
    }
    return rules;
  }
  function resolveCategory(name, rules){
    for(const r of rules){
      const ok1 = name.includes(r.c1);
      const ok2 = r.c2 ? name.includes(r.c2) : true;
      if(ok1 && ok2) return r.cat;
    }
    return '';
  }

  // ===== 詳細判定 =====
  function parseDetailRules(text){
    const arr = lines(text);
    const rules = [];
    for(const line of arr){
      const [detail, cond] = line.split('\t');
      const d = (detail||'').trim();
      const c = (cond||'').trim();
      if(!d || !c) continue;
      rules.push({ detail: d, cond: c });
    }
    return rules;
  }
  function resolveDetail(name, rules){
    for(const r of rules){
      if(name.includes(r.cond)) return r.detail; // 最初に一致したもの
    }
    return '';
  }

  // ===== 出力描画・CSV =====
  function renderTable(rows){
    const tbody = document.getElementById('outBody');
    tbody.innerHTML = '';
    if(rows.length === 0){
      tbody.innerHTML = `<tr><td class="muted" colspan="5">該当する行がありませんでした。</td></tr>`;
      return;
    }
    for(const r of rows){
      const tr = document.createElement('tr');
      // 列順：名称｜日時｜データ種類｜カテゴリ名｜詳細
      tr.innerHTML = `<td>${r.name}</td><td>${r.whenStr}</td><td>${r.type}</td><td>${r.category||''}</td><td>${r.detail||''}</td>`;
      tbody.appendChild(tr);
    }
  }
  function downloadCSV(rows){
    const header = ['名称','日時','データ種類','カテゴリ名','詳細'];
    const escape = (s) => `"${String(s).replace(/"/g,'""')}"`;
    const csv = [header.join(',')].concat(
      rows.map(r=>`${escape(r.name)},${escape(r.whenStr)},${escape(r.type)},${escape(r.category||'')},${escape(r.detail||'')}`)
    ).join('\r\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'activity_merged.csv';
    document.body.appendChild(a); a.click();
    setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 500);
  }

  // ===== 集計本体 =====
  let lastRows = [];
  function runAggregation(){
    const target = getTargetDate();
    const rows = [];

    // 1) ファイルを開いた履歴
    for(const line of lines(document.getElementById('taOpen').value)){
      const [name, timeStr] = line.split('\t');
      if(!name || !timeStr) continue;
      const d = parseTimeOnTargetDay(String(timeStr).trim(), target);
      if(!d) continue;
      rows.push({ type:'ファイル(開)', name: String(name).trim(), when:d, whenStr: fmtYmdHM(d) });
    }

    // 2) 作成・更新履歴（既定GMT-7）
    for(const line of lines(document.getElementById('taCreateUpdate').value)){
      const [name, tsRaw] = line.split('\t');
      if(!name || !tsRaw) continue;
      const d = parseUsAmPmAssumeGMTMinus7(String(tsRaw).trim());
      if(!d) continue;
      rows.push({ type:'ファイル(更)', name: String(name).trim(), when:d, whenStr: fmtYmdHM(d) });
    }

    // 3) メール送信履歴
    for(const line of lines(document.getElementById('taMail').value)){
      const [subj, timeStr] = line.split('\t');
      if(!subj || !timeStr) continue;
      const d = parseTimeOnTargetDay(String(timeStr).trim(), target);
      if(!d) continue;
      rows.push({ type:'メール', name: String(subj).trim(), when:d, whenStr: fmtYmdHM(d) });
    }

    // 4) Teams通話履歴（開始・終了）
    for(const line of lines(document.getElementById('taTeams').value)){
      const parts = line.split('\t');
      if(parts.length < 3) continue;
      const [peer, startStr, endStr] = parts.map(s=>String(s).trim());
      const ds = parseTimeOnTargetDay(startStr, target);
      const de = parseTimeOnTargetDay(endStr, target);
      if(!peer || !ds || !de) continue;
      rows.push({ type:'Teams(開始)', name: peer, when: ds, whenStr: fmtYmdHM(ds) });
      rows.push({ type:'Teams(終了)', name: peer, when: de, whenStr: fmtYmdHM(de) });
    }

    // 5) Teamsチャット履歴
    for(const line of lines(document.getElementById('taTeamsChat').value)){
      const [thread, timeStr] = line.split('\t');
      if(!thread || !timeStr) continue;
      const d = parseTimeOnTargetDay(String(timeStr).trim(), target);
      if(!d) continue;
      rows.push({ type:'Teams(チャット)', name: String(thread).trim(), when:d, whenStr: fmtYmdHM(d) });
    }

    // 6) 会議履歴（開始・終了） ※「〜」/「-」両対応
    for(const line of lines(document.getElementById('taMeet').value)){
      const m = line.match(/^(.+?)\s*\(\s*([0-9]{1,2}:[0-9]{2})\s*[〜\-]\s*([0-9]{1,2}:[0-9]{2})\s*(?:\/.*)?\)$/);
      if(!m) continue;
      const title = m[1].trim();
      const ds = parseTimeOnTargetDay(m[2].trim(), target);
      const de = parseTimeOnTargetDay(m[3].trim(), target);
      if(!ds || !de) continue;
      rows.push({ type:'会議(開始)', name: title, when: ds, whenStr: fmtYmdHM(ds) });
      rows.push({ type:'会議(終了)', name: title, when: de, whenStr: fmtYmdHM(de) });
    }

    // 7) ★ ブラウザアクセス履歴：UTC -> JST(+9)表示、URLは無視、PageTitleを名称に
    for(const line of lines(document.getElementById('taBrowser').value)){
      const parts = line.split('\t');
      if(parts.length < 3) continue;
      const dtStr = String(parts[0]).trim();
      const title = String(parts[2]).trim(); // PageTitle
      if(!dtStr || !title) continue;
      const du = new Date(dtStr);            // UTC ISO などに対応
      if(isNaN(du)) continue;
      rows.push({ type:'ブラウザ', name: title, when: du, whenStr: fmtYmdHM_JST(du) });
    }

    // 8) 勤怠情報
    const kintaiText = document.getElementById('taKintai').value;
    for(const line of lines(kintaiText)){
      const [label, timeStr] = line.split('\t');
      if(!label || !timeStr) continue;
      const d = parseTimeOnTargetDay(String(timeStr).trim(), target);
      if(!d) continue;
      rows.push({ type:'勤怠', name: String(label).trim(), when:d, whenStr: fmtYmdHM(d) });
    }

    // 9) カテゴリ付与
    const catText = document.getElementById('taCategory').value;
    const catRules = parseCategoryRules(catText);
    for(const r of rows){ r.category = resolveCategory(r.name, catRules); }

    // 10) 詳細付与（名称への部分一致）
    const detailText = document.getElementById('taDetailRules').value;
    const detailRules = parseDetailRules(detailText);
    for(const r of rows){ r.detail = resolveDetail(r.name, detailRules); }

    // ★ localStorage 保存（カテゴリ／詳細ルール／勤怠）
    try{
      localStorage.setItem(LS_KEY_CATEGORY, catText);
      localStorage.setItem(LS_KEY_DETAILRULES, detailText);
      localStorage.setItem(LS_KEY_KINTAI, kintaiText);
    }catch(e){ console.warn('設定の保存に失敗:', e); }

    // ソート & 出力
    rows.sort((a,b)=> a.when - b.when);
    lastRows = rows;
    renderTable(rows);

    // CSVボタン更新
    document.getElementById('downloadCsv').onclick = ()=> downloadCSV(lastRows);
  }

  // ===== イベント配線 =====
  document.getElementById('run').addEventListener('click', runAggregation);

  // 各テキストエリアの blur で自動集計（ブラウザ履歴も追加）
  ['taOpen','taCreateUpdate','taMail','taTeams','taTeamsChat','taMeet','taBrowser','taKintai','taCategory','taDetailRules'].forEach(id=>{
    const el = document.getElementById(id);
    if(el){ el.addEventListener('blur', runAggregation); }
  });

  // 「保存済みを読込」ボタン（カテゴリ）
  document.getElementById('btnLoadCategory').addEventListener('click', ()=>{
    try{
      const saved = localStorage.getItem(LS_KEY_CATEGORY);
      if(saved!=null){
        document.getElementById('taCategory').value = saved;
        runAggregation(); // 反映
      }
    }catch(e){ console.warn('カテゴリの読込に失敗:', e); }
  });

  // 初期化：対象日＝前営業日 & 各テキストを自動復元
  (function init(){
    getTargetDate();
    try{
      const savedCat    = localStorage.getItem(LS_KEY_CATEGORY);
      const savedDetail = localStorage.getItem(LS_KEY_DETAILRULES);
      const savedKintai = localStorage.getItem(LS_KEY_KINTAI);
      if(savedCat   != null) document.getElementById('taCategory').value     = savedCat;
      if(savedDetail!= null) document.getElementById('taDetailRules').value  = savedDetail;
      if(savedKintai!= null) document.getElementById('taKintai').value       = savedKintai;
    }catch(e){ /* noop */ }
  })();
})();
</script>
</body>
</html>
